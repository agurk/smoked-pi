<!doctype html>
<title>Smoked Pi</title>
<script type=text/javascript src="{{
  url_for('static', filename='jquery.js') }}"></script>

<input id="button1" type="button" value="Update"
            onclick="startMonitor()"/>

<div align="center">
	<object id="smoker-svg" type="image/svg+xml" data="static/smoker.svg"></object>
	</object>
</div>

<script type=text/javascript >

	function startMonitor() {
		setInterval(updateValues, 1000);
	}

    function updateValues() {
		$.getJSON('/temps/', function (data) {
			flipBlinker();
			$.each(data, function ( sensor, data) {
				changeGauge(sensor, data);
			})
		});
    }

	function flipBlinker() {
		var svg = document.getElementById('smoker-svg').contentDocument
		blinker = svg.getElementById('activity_blinker');
		if (blinker.getAttribute('visibility') === 'hidden') {
			blinker.setAttribute('visibility', 'visible');
		} else {
			blinker.setAttribute('visibility', 'hidden');
		}
	}

	function changeTempDelta(id, amount, colour) {
		var svg = document.getElementById('smoker-svg').contentDocument
		widget = svg.getElementById(id)
		bbox = widget.getBBox()
		wX = bbox.x+(bbox.width/2)
		wY = bbox.y+(bbox.height/2)
		widget.setAttribute('transform', 'translate('+wX+' '+wY+') scale('+amount+' '+amount+') translate('+-wX+' '+-wY+')')
		widget.style.fill=colour
	}

    function changeGauge(gauge, data) {
		temp=data['temperature']
		if (gauge === 'gauge_1' || gauge == 'gauge_2') {
			degrees=(Number(temp['c']) * 2.7) - 135
		} else {
			degrees=(Number(temp['c']) * 0.9) - 135
		}
		var svg = document.getElementById('smoker-svg').contentDocument;
		svg.getElementById(gauge + '-needle').setAttribute("transform", "rotate("+degrees+" 200 200)");
		svg.getElementById(gauge + '-temp_c').textContent=temp['c'];
		svg.getElementById(gauge + '-temp_f').textContent=temp['f'];
		lastUpdate=data['last_update']
		if (lastUpdate > 5) {
			svg.getElementById(gauge + '-no_connection').setAttribute('visibility', 'visible');
		} else {
			svg.getElementById(gauge + '-no_connection').setAttribute('visibility', 'hidden');
		}
    }

</script>

